name: BlueArchive APK Hook

on: 
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  hook-bluearchive:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Android environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          android-tools-adb \
          wget \
          unzip \
          openjdk-11-jdk \
          python3 \
          python3-pip
          
        # å®‰è£…apks2apkå·¥å…·
        pip3 install apks2apk
        
    - name: Start Android emulator
      run: |
        # ä¸‹è½½å¹¶å¯åŠ¨å®‰å“æ¨¡æ‹Ÿå™¨
        wget -q https://github.com/remote-android/redroid-actions/raw/master/start-redroid.sh
        chmod +x start-redroid.sh
        ./start-redroid.sh &
        sleep 60
        
        # æ£€æŸ¥è®¾å¤‡è¿æ¥
        adb devices
        adb wait-for-device
        echo "æ¨¡æ‹Ÿå™¨å¯åŠ¨å®Œæˆ"
        
    - name: Download and extract XAPK
      run: |
        echo "å¼€å§‹ä¸‹è½½Blue Archive XAPKæ–‡ä»¶..."
        wget -O bluearchive.xapk "https://d.apkpure.com/b/XAPK/com.YostarJP.BlueArchive?nc=arm64-v8a&sv=24"
        
        if [ ! -f "bluearchive.xapk" ]; then
          echo "ä¸‹è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨ä¸‹è½½æº"
          # å¤‡ç”¨ä¸‹è½½æ–¹æ³•
          curl -L -o bluearchive.xapk "https://d.apkpure.com/b/XAPK/com.YostarJP.BlueArchive?nc=arm64-v8a&sv=24"
        fi
        
        echo "è§£å‹XAPKæ–‡ä»¶..."
        mkdir -p xapk_extracted
        unzip -o bluearchive.xapk -d xapk_extracted || echo "è§£å‹å¯èƒ½æœ‰é—®é¢˜ï¼Œç»§ç»­å¤„ç†..."
        
        echo "=== XAPKæ–‡ä»¶ç»“æ„ ==="
        find xapk_extracted -type f | sort
        
        # æŸ¥æ‰¾APKæ–‡ä»¶
        mkdir -p final_extracted
        find xapk_extracted -name "*.apk" -exec cp {} final_extracted/ \;
        
        echo "æ‰¾åˆ°çš„APKæ–‡ä»¶:"
        ls -la final_extracted/
        
        # å®‰è£…APKæ–‡ä»¶
        for apk in final_extracted/*.apk; do
          if [ -f "$apk" ]; then
            echo "å®‰è£…: $(basename $apk)"
            adb install -r "$apk" || adb install "$apk"
          fi
        done
        
        # æ£€æŸ¥å®‰è£…ç»“æœ
        echo "å®‰è£…çš„åŒ…:"
        adb shell pm list packages | grep -i bluearchive || adb shell pm list packages | grep -i yostar
        
    - name: Setup Frida server
      run: |
        echo "è®¾ç½®Frida..."
        # ä¸‹è½½frida-server (ä½¿ç”¨x86_64ç‰ˆæœ¬ï¼Œå› ä¸ºGitHub Actionsæ˜¯x86æ¶æ„)
        wget -q https://github.com/frida/frida/releases/download/16.1.8/frida-server-16.1.8-android-x86_64.xz
        xz -d frida-server-16.1.8-android-x86_64.xz || unxz frida-server-16.1.8-android-x86_64.xz
        adb push frida-server-16.1.8-android-x86_64 /data/local/tmp/frida-server
        adb shell "chmod 755 /data/local/tmp/frida-server"
        adb shell "nohup /data/local/tmp/frida-server > /dev/null 2>&1 &"
        
        # ç­‰å¾…fridaå¯åŠ¨
        sleep 10
        
        # æ£€æŸ¥fridaæ˜¯å¦è¿è¡Œ
        echo "æ£€æŸ¥FridaçŠ¶æ€:"
        adb shell "ps | grep frida" || echo "Fridaè¿›ç¨‹å¯èƒ½æœªæ‰¾åˆ°ï¼Œç»§ç»­..."
        
        # å®‰è£…frida-tools
        pip3 install frida-tools
        
    - name: Create hook script
      run: |
        cat > hook_bluearchive.js << 'EOF'
        console.log("[+] Blue Archive Hookè„šæœ¬åŠ è½½å®Œæˆ");

        Java.perform(function() {
            console.log("[+] Javaç¯å¢ƒå‡†å¤‡å°±ç»ª");
            
            // ç­‰å¾…ç±»åŠ è½½
            setTimeout(function() {
                try {
                    console.log("[+] å°è¯•Hookç›®æ ‡ç±»...");
                    
                    // Hook QueuingGetCryptoKeysResponseç±»
                    var targetClass = Java.use("MX.NetworkProtocol.QueuingGetCryptoKeysResponse");
                    console.log("[+] æˆåŠŸæ‰¾åˆ°ç›®æ ‡ç±»");
                    
                    // Hook EncryptedSqlCipherLicense
                    targetClass.set_EncryptedSqlCipherLicense.implementation = function(value) {
                        console.log("\nğŸ¯ HOOKæ•è· - EncryptedSqlCipherLicense");
                        console.log("å€¼: " + value);
                        console.log("ç±»å‹: " + typeof value);
                        console.log("é•¿åº¦: " + (value ? value.length : 0));
                        
                        // ä¿å­˜åˆ°æ–‡ä»¶
                        var File = Java.use("java.io.File");
                        var FileWriter = Java.use("java.io.FileWriter");
                        
                        try {
                            var file = File.$new("/sdcard/encrypted_license.txt");
                            var fw = FileWriter.$new(file);
                            fw.write(value);
                            fw.close();
                            console.log("âœ… Licenseå·²ä¿å­˜åˆ°æ–‡ä»¶");
                        } catch (e) {
                            console.log("âŒ ä¿å­˜æ–‡ä»¶å¤±è´¥: " + e);
                        }
                        
                        return this.set_EncryptedSqlCipherLicense(value);
                    };
                    
                    // Hook EncryptedSqlCipherKey
                    targetClass.set_EncryptedSqlCipherKey.implementation = function(value) {
                        console.log("\nğŸ¯ HOOKæ•è· - EncryptedSqlCipherKey");
                        console.log("å€¼: " + value);
                        console.log("ç±»å‹: " + typeof value);
                        console.log("é•¿åº¦: " + (value ? value.length : 0));
                        
                        // ä¿å­˜åˆ°æ–‡ä»¶
                        var File = Java.use("java.io.File");
                        var FileWriter = Java.use("java.io.FileWriter");
                        
                        try {
                            var file = File.$new("/sdcard/encrypted_key.txt");
                            var fw = FileWriter.$new(file);
                            fw.write(value);
                            fw.close();
                            console.log("âœ… Keyå·²ä¿å­˜åˆ°æ–‡ä»¶");
                        } catch (e) {
                            console.log("âŒ ä¿å­˜æ–‡ä»¶å¤±è´¥: " + e);
                        }
                        
                        return this.set_EncryptedSqlCipherKey(value);
                    };
                    
                    console.log("[+] âœ… Hookè®¾ç½®å®Œæˆï¼Œç­‰å¾…æ¸¸æˆè§¦å‘...");
                    
                } catch (e) {
                    console.log("[-] âŒ Hooké”™è¯¯: " + e);
                    console.log("[-] å †æ ˆ: " + e.stack);
                }
            }, 5000);
        });
        
        // ç›‘æ§æ¸¸æˆå¯åŠ¨
        Java.choose("com.yostarjp.bluearchive.MxUnityPlayerActivity", {
            onMatch: function(instance) {
                console.log("[+] æ¸¸æˆActivityå·²å¯åŠ¨: " + instance);
            },
            onComplete: function() {
                console.log("[+] Activityæœç´¢å®Œæˆ");
            }
        });
        EOF
        
        echo "Hookè„šæœ¬åˆ›å»ºå®Œæˆ"
        
    - name: Start game and run hook
      run: |
        echo "å¯åŠ¨æ¸¸æˆ..."
        # å¯åŠ¨æ¸¸æˆActivity
        adb shell am start -n com.yostarjp.bluearchive/com.yostarjp.bluearchive.MxUnityPlayerActivity
        
        # ç­‰å¾…æ¸¸æˆå¯åŠ¨
        echo "ç­‰å¾…æ¸¸æˆå¯åŠ¨..."
        sleep 30
        
        # æ£€æŸ¥æ¸¸æˆè¿›ç¨‹
        echo "è¿è¡Œä¸­çš„è¿›ç¨‹:"
        adb shell "ps | grep bluearchive" || echo "æ¸¸æˆè¿›ç¨‹æœªæ‰¾åˆ°"
        
        # è¿è¡ŒFrida hook (è¶…æ—¶5åˆ†é’Ÿ)
        echo "å¯åŠ¨Frida Hook..."
        timeout 300 frida -U -l hook_bluearchive.js -f com.yostarjp.bluearchive --no-pause --runtime=v8 || echo "Fridaæ‰§è¡Œå®Œæˆæˆ–è¶…æ—¶"
        
    - name: Collect and display results
      run: |
        echo "=== æ”¶é›†Hookç»“æœ ==="
        
        # æ£€æŸ¥æ–‡ä»¶
        echo "SDå¡æ–‡ä»¶åˆ—è¡¨:"
        adb shell "ls -la /sdcard/*.txt 2>/dev/null" || echo "æœªæ‰¾åˆ°txtæ–‡ä»¶"
        
        # æ‹‰å–ç»“æœæ–‡ä»¶
        echo "æ‹‰å–ç»“æœæ–‡ä»¶..."
        adb pull /sdcard/encrypted_license.txt ./captured_license.txt 2>/dev/null || echo "æœªæ‰¾åˆ°licenseæ–‡ä»¶"
        adb pull /sdcard/encrypted_key.txt ./captured_key.txt 2>/dev/null || echo "æœªæ‰¾åˆ°keyæ–‡ä»¶"
        
        # æ˜¾ç¤ºç»“æœ
        echo "=== æ•è·ç»“æœ ==="
        if [ -f "captured_license.txt" ]; then
          echo "âœ… EncryptedSqlCipherLicense:"
          cat captured_license.txt
          echo ""
        else
          echo "âŒ æœªæ•è·åˆ°EncryptedSqlCipherLicense"
        fi
        
        if [ -f "captured_key.txt" ]; then
          echo "âœ… EncryptedSqlCipherKey:"
          cat captured_key.txt
          echo ""
        else
          echo "âŒ æœªæ•è·åˆ°EncryptedSqlCipherKey"
        fi
        
        # åˆ›å»ºæ€»ç»“æ–‡ä»¶
        echo "BlueArchive Hookç»“æœæ€»ç»“" > summary.txt
        echo "è¿è¡Œæ—¶é—´: $(date)" >> summary.txt
        echo "Licenseæ•è·: $(if [ -f "captured_license.txt" ]; then echo "æˆåŠŸ"; else echo "å¤±è´¥"; fi)" >> summary.txt
        echo "Keyæ•è·: $(if [ -f "captured_key.txt" ]; then echo "æˆåŠŸ"; else echo "å¤±è´¥"; fi)" >> summary.txt
        
    - name: Upload results as artifact
      uses: actions/upload-artifact@v4
      with:
        name: bluearchive-hook-results
        path: |
          captured_license.txt
          captured_key.txt
          summary.txt
        retention-days: 7
        
    - name: Final cleanup
      run: |
        echo "=== å·¥ä½œæµå®Œæˆ ==="
        echo "ç»“æœå·²ä¿å­˜ä¸ºArtifact: bluearchive-hook-results"
        echo "å¯ä»¥åœ¨Actionsé¡µé¢ä¸‹è½½ç»“æœæ–‡ä»¶"
